<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red & Black AI-Powered Editor Project Downloader</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* --- Red & Black Themed CSS --- */
        body {
            display: flex;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #1a1a1a; /* Dark background */
            color: #f0f0f0;
        }

        /* --- Sidebar (Toolbox) Styling --- */
        #sidebar {
            width: 200px;
            background-color: #0d0d0d; /* Black */
            color: #f0f0f0;
            padding: 20px;
            flex-shrink: 0;
            border-right: 2px solid #ff0000; /* Red border */
        }

        .element-box {
            background-color: #ff0000; /* Red element background */
            color: #0d0d0d; /* Black text */
            padding: 10px;
            margin-bottom: 10px;
            text-align: center;
            cursor: grab;
            border-radius: 2px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .element-box:hover {
            background-color: #cc0000;
        }

        /* --- Canvas (Dropzone) Styling --- */
        #canvas {
            flex-grow: 1;
            border: 2px dashed #ff0000; /* Red dashed border */
            margin: 20px;
            padding: 20px;
            background-color: #2a2a2a; /* Darker grey canvas */
            color: #f0f0f0;
            min-height: calc(100vh - 40px);
            overflow-y: auto;
            position: relative;
        }

        #canvas.drag-over {
            border-color: #cc0000;
            background-color: #380000; /* Dark red highlight */
        }

        /* Styling for elements dropped onto the canvas */
        .dropped-element {
            min-height: 50px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #1a1a1a; /* Black background for elements */
            color: #f0f0f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            line-height: 1.5;
            border-left: 5px solid #ff0000; /* Red accent bar */
            position: relative;
        }
        .dropped-element h3 { color: #ff9999; }

        /* --- Button Styling --- */
        #export-btn, #ai-generate-btn {
            position: fixed;
            bottom: 20px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            transition: background-color 0.2s;
        }
        
        /* Download Project ZIP (Export) Button */
        #export-btn {
            right: 20px;
            background-color: #cc0000; /* Darker Red */
            color: white;
        }
        #export-btn:hover {
            background-color: #990000;
        }
        
        /* AI Generate Button */
        #ai-generate-btn {
            right: 210px;
            background-color: #ff0000; /* Bright Red */
            color: #0d0d0d;
            display: flex;
            align-items: center;
        }
        #ai-generate-btn:hover {
            background-color: #cc0000;
        }

        .loader {
            border: 4px solid #444; 
            border-top: 4px solid #ff0000; /* Red spinner */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>PROJECT TOOLS</h3>
        <div class="element-box" draggable="true" data-type="header">Header Block</div>
        <div class="element-box" draggable="true" data-type="paragraph">Text Paragraph</div>
        <div class="element-box" draggable="true" data-type="button">Action Button</div>
    </div>
    <div id="canvas">
        <h2>Your Website Canvas</h2>
        <p>Drag elements from the left panel onto this area.</p>
    </div>

    <button id="export-btn">Download Project ZIP</button>
    <button id="ai-generate-btn">
        <span>AI Generate Text</span>
        <div class="loader" id="ai-loader"></div>
    </button>

    <script>
        const canvas = document.getElementById('canvas');
        const elementBoxes = document.querySelectorAll('.element-box');
        const exportBtn = document.getElementById('export-btn');
        const aiGenerateBtn = document.getElementById('ai-generate-btn');
        const aiLoader = document.getElementById('ai-loader');

        // --- Configuration ---
        const API_ENDPOINT = "/api/generate-content"; 
        // EDIT YOUR PROMPT HERE:
        const PROMPT = "Write a compelling, short, and professional paragraph for a new website about a smart drag-and-drop editor."; 
        let selectedElement = null;

        // --- Drag/Drop and Element Creation Logic ---
        elementBoxes.forEach(box => {
            box.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.getAttribute('data-type'));
            });
        });

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            canvas.classList.add('drag-over');
        });

        canvas.addEventListener('dragleave', () => {
            canvas.classList.remove('drag-over');
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            canvas.classList.remove('drag-over');
            const dataType = e.dataTransfer.getData('text/plain');
            const newElement = document.createElement('div');
            newElement.classList.add('dropped-element');
            newElement.setAttribute('data-selected', 'false');

            if (dataType === 'header') {
                newElement.innerHTML = '<h3>New Section Header</h3><p>Double-click to edit or select for AI generation.</p>';
            } else if (dataType === 'paragraph') {
                newElement.innerHTML = '<p>This is a paragraph of text. Double-click to edit or select for AI generation.</p>';
            } else if (dataType === 'button') {
                newElement.innerHTML = '<button style="background-color: #ff0000; color: #0d0d0d; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">VIEW DEMO</button>';
            } else {
                return;
            }
            canvas.appendChild(newElement);
            selectElement(newElement);
        });

        // --- Selection and Editor Logic ---
        function selectElement(element) {
            if (selectedElement) {
                selectedElement.style.boxShadow = 'none';
                selectedElement.setAttribute('data-selected', 'false');
            }
            selectedElement = element;
            selectedElement.style.boxShadow = '0 0 0 2px #ff0000 inset';
            selectedElement.setAttribute('data-selected', 'true');
        }

        canvas.addEventListener('click', (e) => {
            let target = e.target.closest('.dropped-element');
            if (target && target !== canvas) {
                selectElement(target);
            }
        });

        canvas.addEventListener('dblclick', (e) => {
            let target = e.target;
            while (target && target !== canvas) {
                if (['P', 'H3', 'BUTTON'].includes(target.tagName)) {
                    target.contentEditable = true;
                    target.focus();
                    target.style.outline = '2px dashed #ff0000';
                    break;
                }
                target = target.parentElement;
            }
        });

        document.addEventListener('blur', (e) => {
            if (e.target.contentEditable === 'true') {
                e.target.contentEditable = 'false';
                e.target.style.outline = 'none';
            }
        }, true);

        // --- AI GENERATION (API CALL) ---
        aiGenerateBtn.addEventListener('click', async () => {
            if (!selectedElement) {
                alert("Please click on a dropped element (like a paragraph or header) on the canvas to select it first.");
                return;
            }

            aiLoader.style.display = 'inline-block';
            aiGenerateBtn.querySelector('span').textContent = 'GENERATING...';

            try {
                // The client calls the secure backend (Vercel Serverless Function)
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: PROMPT }) 
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const data = await response.json();
                const generatedText = data.text || "Error: No text received from AI.";
                
                const editableTarget = selectedElement.querySelector('h3, p');
                if (editableTarget) {
                    editableTarget.textContent = generatedText;
                } else {
                    selectedElement.innerHTML = `<p>${generatedText}</p>`;
                }

            } catch (error) {
                console.error("AI Generation Error:", error);
                alert("Could not generate text. Check the console and ensure your Vercel API endpoint is configured correctly.");
            } finally {
                aiLoader.style.display = 'none';
                aiGenerateBtn.querySelector('span').textContent = 'AI Generate Text';
            }
        });

        // --- PROJECT FILE CONTENTS FOR ZIP ---
        
        // 1. Exported HTML (Your built website)
        const getExportedHTML = (content) => `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Exported AI Website</title>
    <style>
        /* Exported Red & Black Styles */
        body { margin: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a1a; color: #f0f0f0;}
        .dropped-element {
            min-height: 50px; padding: 15px; margin-bottom: 15px; border: 1px solid #555;
            border-radius: 4px; background-color: #0d0d0d; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            line-height: 1.5; border-left: 5px solid #ff0000;
        }
        .dropped-element h3 { color: #ff9999; }
        button { background-color: #ff0000; color: #0d0d0d; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
${content}
</body>
</html>`;

        // 2. package.json (Vercel Configuration)
        const packageJsonContent = `{
  "name": "red-black-ai-editor-vercel-project",
  "version": "1.0.0",
  "description": "A simple drag-and-drop editor with Gemini AI integration.",
  "scripts": {
    "start": "echo 'Run the client via Vercel deployment'"
  },
  "dependencies": {
    "@google/genai": "^0.1.0"
  }
}`;

        // 3. api/generate-content.js (Secure Backend Code)
        const apiCodeContent = `// api/generate-content.js (Node.js/Vercel Serverless Function)

import { GoogleGenAI } from '@google/genai';

// IMPORTANT: Vercel securely injects the GEMINI_API_KEY environment variable here.
// DO NOT ADD YOUR KEY TO THIS FILE! Set it in the Vercel dashboard.
const apiKey = process.env.GEMINI_API_KEY; 

if (!apiKey) {
    throw new Error('GEMINI_API_KEY environment variable not set. Check Vercel settings.');
}

const ai = new GoogleGenAI({ apiKey });

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method Not Allowed' });
  }

  try {
    const { prompt } = req.body;

    const response = await ai.models.generateContent({
        model: "gemini-2.5-flash",
        contents: [
            { role: "user", parts: [{ text: prompt }] }
        ],
        config: {
            temperature: 0.7,
        }
    });

    res.status(200).json({ text: response.text });

  } catch (error) {
    console.error("Gemini API Error:", error);
    res.status(500).json({ error: 'Failed to generate content from AI.' });
  }
}
`;

        // --- ZIP Download Logic ---
        exportBtn.addEventListener('click', async () => {
            alert("Creating Vercel project zip... Please wait.");
            
            let exportContent = canvas.innerHTML;
            exportContent = exportContent.replace(/<h2>Your Website Canvas<\/h2>[\s\S]*?<p>Drag elements.*<\/p>/, '');
            exportContent = exportContent.replace(/ data-selected="true"/g, '');
            
            // The final index.html needs to be a clean version of the editor output
            const finalHTML = getExportedHTML(exportContent);

            const zip = new JSZip();
            
            // Vercel project structure files:
            zip.file("index.html", finalHTML);
            zip.file("package.json", packageJsonContent);
            
            const apiFolder = zip.folder("api");
            apiFolder.file("generate-content.js", apiCodeContent);
            
            // Generate the ZIP file
            const content = await zip.generateAsync({ type: "blob" });

            // Trigger the download using the FileSaver library
            saveAs(content, "red_black_ai_editor_project.zip");

            alert('Your complete Vercel project has been downloaded! You can now upload this ZIP to GitHub to deploy.');
        });
    </script>
</body>
</html>
